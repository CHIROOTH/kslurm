#!/usr/bin/env python
import sys, subprocess
from pathlib import Path
try:
    from colorama import Fore
except:
    from colors import Fore

from slurm_args import SlurmCommand
import toolz_stub as tz

def get_config_path(name):
    candidates = [
        Path(parent, name).with_suffix(suffix) 
            for parent in [".", "config"] 
                for suffix in [".yaml", ".yml"]
    ]
    exist = [c.exists() for c in candidates]
    if any(exist):
        return tz.second(
                tz.first(
                filter(lambda x: tz.first(x),
                zip(exist, candidates)
        )))
    else:
        return None

if __name__ == "__main__":
    slurm = SlurmCommand(sys.argv[1:])
    if len(slurm.command_list) < 1:
        print(f"{Fore.RED}Must provide a profile")
        exit()
    profile = slurm.command_list[0]
    if not (Path.home() / ".config" / "snakemake" / profile / "config.yml").exists():
        print(f"{Fore.RED}\"{Fore.LIGHTRED_EX + profile + Fore.RED}\" is not a valid profile")
        exit()
    
    args = slurm.command_list[1:]
    slurm.submit_script = [
        "panoptes --ip $(hostname -f) 1> panoptes.out 2>&1 &",
        "PANOPTES_PID=$!",
        "hostname -f",
        f"snakemake --wms-monitor \"$(hostname -f):5000\" --profile {profile} {' '.join(args)}",
        "kill $PANOPTES_PID"
    ]
    subprocess.run(f"{slurm.batch}", shell=True)
    
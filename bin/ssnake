#!/usr/bin/env python
import sys, subprocess
from pathlib import Path
try:
    from colorama import Fore
except:
    from mock_colors import Fore

from slurm_args import SlurmCommand
import toolz_stub as tz

def get_config_path(name):
    candidates = [
        Path(parent, name).with_suffix(suffix) 
            for parent in [".", "config"] 
                for suffix in [".yaml", ".yml"]
    ]
    exist = [c.exists() for c in candidates]
    if any(exist):
        return tz.second(
                tz.first(
                filter(lambda x: tz.first(x),
                zip(exist, candidates)
        )))
    else:
        return None

if __name__ == "__main__":
    slurm = SlurmCommand(sys.argv[1:])
    if len(slurm.command_list) < 2:
        print("Must provide both a profile and config")
        exit()
    profile = slurm.command_list[0]
    config = get_config_path(slurm.command_list[1])
    if not config:
        print(f"{Fore.RED}No valid config found for \"{Fore.YELLOW + slurm.command_list[1] + Fore.RED}\"")
        exit()
    
    args = slurm.command_list[2:]
    slurm.submit_script = [
        "panoptes --ip $(hostname -f) 1> panoptes.out 2>&1 &",
        "PANOPTES_PID=$!",
        "hostname -f",
        f"snakemake --wms-monitor \"$(hostname -f):5000\" --profile {profile} --configfile {config} {' '.join(args)}",
        "kill $PANOPTES_PID"
    ]
    subprocess.run(f"{slurm.batch}", shell=True)
    